                                                                            <!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Withdrawal Processing</title>
  <link rel="stylesheet" href="css/styles.css">
  <style>
    body{margin:0;padding:24px;font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg,#f8f9fb);color:var(--text,#111);}
    .wrap{max-width:720px;margin:0 auto;}
    .card{background:var(--card,#fff);border:1px solid var(--border,#e5e7eb);border-radius:10px;padding:20px;box-shadow:0 1px 4px rgba(0,0,0,0.05);margin-bottom:16px;}
    .muted{color:var(--muted);}
    .alert{padding:12px 14px;border-radius:8px;border-left:4px solid;}
    .alert-info{background:#eef2ff;border-color:#6366f1;color:#312e81;}
    .alert-warn{background:#fff7ed;border-color:#fb923c;color:#9a3412;}
    .alert-success{background:#ecfdf3;border-color:#10b981;color:#065f46;}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;}
  </style>
</head>
<body>
  <div class="wrap">
    <h2>Withdrawal processing</h2>

    <div class="card">
      <p>Your withdrawal is being processed. Admin and banking confirmation are required.</p>
      <div id="status-block" class="alert alert-info">Checking fee confirmation...</div>
      <div id="fee-info" class="alert alert-warn" style="display:none;">
        Fee not confirmed yet. Please complete the 30% fee on the previous step and wait for admin confirmation.
      </div>
      <div id="complete-info" class="alert alert-success" style="display:none;">
        Fee confirmed. Awaiting admin and bank confirmation. You will be redirected shortly.
      </div>
      <div class="actions">
        <button class="btn" id="go-dashboard">Back to dashboard</button>
        <button class="btn-secondary" id="refresh">Refresh status</button>
      </div>
      <p class="muted" style="margin-top:12px;">Network processing requires a 15% BNB fee which is handled during admin processing. No progress bar is shown; you will be notified once confirmed.</p>
    </div>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const withdrawalId = params.get('withdrawalId');
    const API_BASE = (location.hostname === 'localhost' || location.hostname === '127.0.0.1')
      ? `http://${location.hostname}:5001/api`
      : '/api';
    const TOKEN = (window.AuthService && typeof AuthService.getToken === 'function')
      ? AuthService.getToken()
      : (localStorage.getItem('authToken') || localStorage.getItem('token'));

    if (!TOKEN) { window.location.href = 'login.html'; }

    async function fetchStatus() {
      const resp = await fetch(`${API_BASE}/withdrawals/${withdrawalId}`, {
        headers: { Authorization: `Bearer ${TOKEN}` },
      });
      if (!resp.ok) throw new Error('Failed to fetch withdrawal');
      const data = await resp.json();
      return data.withdrawal;
    }

    async function check() {
      try {
        const w = await fetchStatus();
        if (w.fee_status !== 'confirmed') {
          document.getElementById('fee-info').style.display = 'block';
          document.getElementById('status-block').textContent = 'Fee not confirmed yet.';
          return;
        }
        document.getElementById('fee-info').style.display = 'none';
        document.getElementById('complete-info').style.display = 'block';
        document.getElementById('status-block').textContent = 'Fee confirmed.';
        setTimeout(()=> window.location.href = 'dashboard.html', 1500);
      } catch (e) {
        document.getElementById('status-block').textContent = e.message || 'Unable to fetch status';
      }
    }

    document.getElementById('refresh').addEventListener('click', check);
    document.getElementById('go-dashboard').addEventListener('click', () => window.location.href = 'dashboard.html');
    if (withdrawalId) check();
  </script>
</body>
</html>

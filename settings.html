<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Settings ‚Äî ELON ULTRA ELONS</title>
  <link rel="stylesheet" href="css/styles.css">
  <style>
    .testimonies-banner { width: 100%; padding: 8px 12px; position: relative; min-height: 36px; display: flex; align-items: center; margin-bottom: 16px; box-sizing: border-box; overflow: hidden; }
    .testimonies-banner-content { display: flex; gap: 24px; width: max-content; align-items: center; will-change: transform; }
    .testimonies-banner-item { display: flex; flex-direction: column; gap: 2px; flex-shrink: 0; padding: 12px 18px; background: rgba(251, 191, 36, 0.2); border-radius: 6px; backdrop-filter: blur(8px); font-size: 13px; color: #e0e7ff; border: 1.5px solid rgba(251, 191, 36, 0.6); min-width: 280px; max-width: 380px; }
    .testimonies-banner-item strong { color: #fbbf24; font-weight: 700; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
    .testimonies-banner-item-text { font-style: italic; line-height: 1.3; font-size: 12px; color: #cbd5e1; }
    @keyframes scroll-left { from { transform: translateX(0); } to { transform: translateX(-50%); } }
    @media (max-width: 768px) { .testimonies-banner { padding: 6px 8px; min-height: 32px; margin-bottom: 12px; } .testimonies-banner-content { gap: 18px; } .testimonies-banner-item { padding: 10px 14px; font-size: 12px; min-width: 240px; max-width: 300px; border-radius: 5px; } .testimonies-banner-item strong { font-size: 11px; } .testimonies-banner-item-text { font-size: 11px; } }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="container">
      <a href="landing.html" class="brand"><img src="images/elon-logo-v2.svg" alt="EUE"><span style="display:block">ELON ULTRA ELONS</span></a>
      <nav class="nav">
        <a href="dashboard.html">Dashboard</a>
        <a href="markets.html">Markets</a>
        <a href="settings.html">Settings</a>
        <a href="contact.html">Support</a>
        <button class="theme-toggle" style="margin:0 12px">‚òÄÔ∏è Light Mode</button>
        <a href="#" onclick="logout()" style="color:#ef4444">Logout</a>
      </nav>
    </div>
  </header>

  <div class="app-wrapper">
    <aside class="sidebar">
      <a href="dashboard.html" class="sidebar-link">üìä Dashboard</a>
      <a href="markets.html" class="sidebar-link">üìà Markets</a>
      <a href="transactions.html" class="sidebar-link">üí≥ Transactions</a>
      <a href="settings.html" class="sidebar-link active">‚öôÔ∏è Settings</a>
      <a href="help.html" class="sidebar-link">‚ùì Help & Docs</a>
    </aside>

    <main class="main-content" style="max-width:900px">
      <!-- Testimonies Scrolling Banner -->
      <div id="testimonies-banner" class="testimonies-banner"></div>

      <h1>Account Settings</h1>

      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:24px;margin-top:24px">
        <div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
            <h2 style="margin:0">Profile</h2>
            <button type="button" id="edit-profile-btn" class="btn" style="padding:6px 12px;font-size:14px">Edit</button>
          </div>
          <div id="profile-view" style="display:block">
            <div style="padding:16px;background:var(--surface);border-radius:8px;border:1px solid var(--border)">
              <div style="margin-bottom:16px">
                <p style="color:var(--muted);font-size:12px;margin:0 0 4px 0">Full Name</p>
                <p style="font-weight:500;margin:0" id="profile-name">John Doe</p>
              </div>
              <div style="margin-bottom:16px">
                <p style="color:var(--muted);font-size:12px;margin:0 0 4px 0">Email</p>
                <p style="font-weight:500;margin:0" id="profile-email">john@example.com</p>
              </div>
              <div>
                <p style="color:var(--muted);font-size:12px;margin:0 0 4px 0">Phone</p>
                <p style="font-weight:500;margin:0" id="profile-phone">+1 234 567 8900</p>
              </div>
            </div>
          </div>
          <form class="form" id="profile-form" style="display:none">
            <label><span>Full Name</span><input type="text" id="input-name" value="John Doe"></label>
            <label><span>Email</span><input type="email" id="input-email" value="john@example.com"></label>
            <label><span>Phone</span><input type="tel" id="input-phone" value="+1 234 567 8900"></label>
            <div style="display:flex;gap:8px">
              <button type="submit" class="btn">Save Profile</button>
              <button type="button" id="cancel-profile-btn" class="btn" style="background:var(--muted);color:white">Cancel</button>
            </div>
          </form>
        </div>

        <div>
          <h2 style="margin-top:0">Security</h2>
          <form class="form" id="security-form">
            <label><span>Current Password</span><input type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"></label>
            <label><span>New Password</span><input type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="new-password"></label>
            <label><span>Confirm Password</span><input type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="new-password"></label>
            <button type="submit" class="btn">Update Password</button>
          </form>
        </div>
      </div>

      <h2 style="margin-top:48px">API Keys</h2>
      <p class="muted">Use these keys to access the API programmatically</p>
      <div class="table-wrapper">
        <div class="table-header">
          <h3>Your API Keys</h3>
        </div>
        <table>
          <thead>
            <tr>
              <th>Key</th>
              <th>Created</th>
              <th>Last Used</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>sk_live_4e...8f</code></td>
              <td>2025-01-15</td>
              <td>2025-01-27</td>
              <td><button class="btn btn-danger" style="font-size:12px">Revoke</button></td>
            </tr>
          </tbody>
        </table>
      </div>
      <button class="btn mt-6" onclick="alert('API key generation coming soon')">Generate New Key</button>

      <h2 style="margin-top:48px">Preferences</h2>
      <form class="form" id="preferences-form">
        <label style="flex-direction:row;align-items:center;gap:12px">
          <input type="checkbox" checked> Email notifications for trades
        </label>
        <label style="flex-direction:row;align-items:center;gap:12px">
          <input type="checkbox"> Price alerts above 5% change
        </label>
        <label style="flex-direction:row;align-items:center;gap:12px">
          <input type="checkbox" checked> Two-factor authentication
        </label>
        <button type="submit" class="btn">Save Preferences</button>
      </form>

      <h2 style="margin-top:48px">Account Banking & Verification</h2>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:24px;margin-top:12px">
        <div class="card" style="padding:12px">
          <h3 style="margin-top:0">Banking / Registration</h3>
          <form id="embedded-reg">
            <label><span>Country</span>
              <select name="country">
                <option value="">Select country</option>
                <option>United States</option>
                <option>Nigeria</option>
                <option>United Kingdom</option>
                <option>Kenya</option>
                <option>Ghana</option>
              </select>
            </label>
            <label><span>Account number</span><input name="acctNumber" placeholder="1234567890"></label>
            <label><span>Account name</span><input name="acctName" placeholder="Full name on account"></label>
            <label><span>Personal ID</span><input name="personalId" placeholder="National ID / Passport"></label>
            <label><span>Branch</span><input name="branch" placeholder="Branch name or code"></label>
            <label><span>Email</span><input name="email" type="email" placeholder="you@example.com"></label>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button type="button" id="settings-sendCode" class="btn">Send verification code</button>
              <input name="code" placeholder="Verification code" style="flex:1;min-width:150px" />
            </div>
            <div style="margin-top:12px">
              <button type="button" id="settings-register" class="btn">Save banking details</button>
            </div>
            <p id="settings-msg" style="color:green;margin-top:8px"></p>
          </form>
        </div>

        <div class="card" style="padding:12px">
          <h3 style="margin-top:0">Email Verification</h3>
          <form id="embedded-verify">
            <label><span>Email</span><input name="email" type="email" placeholder="you@example.com"></label>
            <label><span>Verification code</span><input name="code" placeholder="Enter code"></label>
            <button type="button" id="settings-verify" class="btn">Verify Email</button>
            <p id="verify-msg" style="color:green;margin-top:8px"></p>
          </form>
        </div>
      </div>

      <h2 style="margin-top:48px;color:var(--danger)">Danger Zone</h2>
      <button class="btn btn-danger" onclick="if(confirm('Delete account? This cannot be undone.')) alert('Account deletion pending...')">Delete Account</button>
    </main>
  </div>

  <footer class="site-footer">
    <div class="container">&copy; 2025 ELON ULTRA ELONS ‚Äî Professional Crypto Trading</div>
  </footer>

  <!-- Mobile Bottom Navigation -->
  <nav class="mobile-bottom-nav">
    <a href="/dashboard.html" class="nav-item" title="Dashboard">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M3 13h2v8H3zm4-8h2v16H7zm4-2h2v18h-2zm4 4h2v14h-2zm4-4h2v18h-2z"/></svg>
    </a>
    <a href="/markets.html" class="nav-item" title="Markets">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M3 13h1v7H3zm3-4h1v11H6zm3-3h1v14H9zm3 6h1v8h-1zm3-2h1v10h-1zm3 4h1v6h-1z"/><path d="M19 3v1" stroke="currentColor" stroke-width="2"/></svg>
    </a>
    <a href="/transactions.html" class="nav-item" title="Transactions">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
    </a>
    <a href="/settings.html" class="nav-item active" title="Account">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
    </a>
    <a href="/help.html" class="nav-item" title="Help">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
    </a>
  </nav>

  <script>
    function logout(){
      localStorage.removeItem('authToken');
      localStorage.removeItem('currentUser');
      window.location.href = '/login.html';
    }
    document.getElementById('profile-form').addEventListener('submit', (e) => {
      e.preventDefault();
      alert('Profile updated!');
    });
    document.getElementById('security-form').addEventListener('submit', (e) => {
      e.preventDefault();
      alert('Password updated!');
    });
    document.getElementById('preferences-form').addEventListener('submit', (e) => {
      e.preventDefault();
      alert('Preferences saved!');
    });

    // Embedded registration handlers (settings page)
    (function(){
      const regForm = document.getElementById('embedded-reg');
      const verifyForm = document.getElementById('embedded-verify');

      // Profile edit/view toggle
      const profileView = document.getElementById('profile-view');
      const profileForm = document.getElementById('profile-form');
      const editBtn = document.getElementById('edit-profile-btn');
      const cancelBtn = document.getElementById('cancel-profile-btn');

      async function loadProfileData(){
        try{
          // Check if AuthService is available
          if (typeof AuthService === 'undefined') {
            console.warn('AuthService not loaded yet, retrying...');
            setTimeout(loadProfileData, 100);
            return;
          }
          
          try {
            // Try to fetch fresh user data from server
            const user = await AuthService.fetchUserProfile();
            const name = user.fullName || user.full_name || user.name || 'John Doe';
            const email = user.email || 'john@example.com';
            const phone = user.phone || '+1 234 567 8900';
            
            document.getElementById('profile-name').textContent = name;
            document.getElementById('profile-email').textContent = email;
            document.getElementById('profile-phone').textContent = phone;
            document.getElementById('input-name').value = name;
            document.getElementById('input-email').value = email;
            document.getElementById('input-phone').value = phone;
          } catch (serverErr) {
            console.warn('Server fetch failed, using localStorage:', serverErr.message);
            // Fallback to localStorage if server fetch fails
            const user = AuthService.getUser() || {};
            const name = user.fullName || user.full_name || user.name || 'John Doe';
            const email = user.email || 'john@example.com';
            const phone = user.phone || '+1 234 567 8900';
            
            document.getElementById('profile-name').textContent = name;
            document.getElementById('profile-email').textContent = email;
            document.getElementById('profile-phone').textContent = phone;
            document.getElementById('input-name').value = name;
            document.getElementById('input-email').value = email;
            document.getElementById('input-phone').value = phone;
          }
        }catch(e){
          console.warn('Failed to load profile', e);
          // Last resort fallback
          try {
            const user = AuthService.getUser() || {};
            const name = user.fullName || user.full_name || user.name || 'John Doe';
            const email = user.email || 'john@example.com';
            const phone = user.phone || '+1 234 567 8900';
            
            document.getElementById('profile-name').textContent = name;
            document.getElementById('profile-email').textContent = email;
            document.getElementById('profile-phone').textContent = phone;
            document.getElementById('input-name').value = name;
            document.getElementById('input-email').value = email;
            document.getElementById('input-phone').value = phone;
          } catch(e2) {
            console.warn('Failed to load local profile data', e2);
          }
        }
      }

      loadProfileData();

      function setupFormHandlers() {
        if (typeof AuthService === 'undefined') {
          setTimeout(setupFormHandlers, 100);
          return;
        }

        editBtn.addEventListener('click', () => {
          profileView.style.display = 'none';
          profileForm.style.display = 'block';
        });

        cancelBtn.addEventListener('click', (e) => {
          e.preventDefault();
          profileView.style.display = 'block';
          profileForm.style.display = 'none';
        });

        profileForm.addEventListener('submit', (e) => {
          e.preventDefault();
          const name = document.getElementById('input-name').value.trim();
          const email = document.getElementById('input-email').value.trim();
          const phone = document.getElementById('input-phone').value.trim();
          
          if (!name || !email) {
            alert('Full name and email are required');
            return;
          }

          // Save to backend
          AuthService.updateProfile(name, email, phone)
          .then(user => {
            console.log('Profile update response:', user);
            
            // Get the updated data - prioritize what server returned
            const displayName = user.fullName || user.full_name || user.name || name;
            const displayEmail = user.email || email;
            const displayPhone = user.phone || phone || '';
            
            // Update localStorage immediately
            const currentUser = AuthService.getUser() || {};
            currentUser.fullName = displayName;
            currentUser.full_name = displayName;
            currentUser.name = displayName;
            currentUser.email = displayEmail;
            currentUser.phone = displayPhone;
            AuthService.setUser(currentUser);
            
            // Update read-only display with the saved values - FORCE UPDATE
            const profileNameEl = document.getElementById('profile-name');
            const profileEmailEl = document.getElementById('profile-email');
            const profilePhoneEl = document.getElementById('profile-phone');
            
            if (profileNameEl) profileNameEl.textContent = displayName;
            if (profileEmailEl) profileEmailEl.textContent = displayEmail;
            if (profilePhoneEl) profilePhoneEl.textContent = displayPhone;
            
            // Update form inputs to match display
            document.getElementById('input-name').value = displayName;
            document.getElementById('input-email').value = displayEmail;
            document.getElementById('input-phone').value = displayPhone;
            
            // Toggle view
            profileView.style.display = 'block';
            profileForm.style.display = 'none';
            
            alert('‚úì Profile updated successfully');
          })
          .catch(err => {
            console.error('Profile update error:', err);
            alert('Failed to update profile: ' + err.message);
          });
        });
      }

      setupFormHandlers();

      function loadSaved(){
        try{
          const saved = JSON.parse(localStorage.getItem('banking')||'{}');
          if(saved){
            regForm.country.value = saved.country||'';
            regForm.acctNumber.value = saved.acctNumber||'';
            regForm.acctName.value = saved.acctName||'';
            regForm.personalId.value = saved.personalId||'';
            regForm.branch.value = saved.branch||'';
            regForm.email.value = saved.email||'';
            verifyForm.email.value = saved.email||'';
          }
        }catch(e){console.warn('Failed to load saved banking',e)}
      }

      loadSaved();

      document.getElementById('settings-sendCode').addEventListener('click', ()=>{
        document.getElementById('settings-msg').textContent = 'Verification code sent (simulated)';
        setTimeout(()=>document.getElementById('settings-msg').textContent = '',3000);
      });

      document.getElementById('settings-register').addEventListener('click', ()=>{
        const fd = new FormData(regForm);
        const body = Object.fromEntries(fd.entries());
        // basic validation
        if(!body.acctNumber || !body.acctName || !body.email){
          document.getElementById('settings-msg').textContent = 'Please provide account number, account name and email.';
          setTimeout(()=>document.getElementById('settings-msg').textContent = '',4000);
          return;
        }
        // persist locally for demo
        localStorage.setItem('banking', JSON.stringify(body));
        document.getElementById('settings-msg').textContent = 'Banking details saved locally (simulated)';
        setTimeout(()=>document.getElementById('settings-msg').textContent = '',3000);
      });

      document.getElementById('settings-verify').addEventListener('click', ()=>{
        const fd = new FormData(verifyForm);
        const body = Object.fromEntries(fd.entries());
        if(!body.email || !body.code){
          document.getElementById('verify-msg').textContent = 'Enter email and verification code.';
          setTimeout(()=>document.getElementById('verify-msg').textContent = '',3000);
          return;
        }
        // simulate verification and mark in local storage
        const saved = JSON.parse(localStorage.getItem('banking')||'{}');
        saved.emailVerified = true;
        localStorage.setItem('banking', JSON.stringify(saved));
        document.getElementById('verify-msg').textContent = 'Email verified (simulated)';
        setTimeout(()=>document.getElementById('verify-msg').textContent = '',3000);
      });
    })();
  </script>
  <script src="/js/auth.js"></script>
  <script>
    // *** CRITICAL: Protect settings page from unauthorized access ***
    (function() {
      if (!AuthService.isAuthenticated()) {
        console.warn('Settings access denied: User not authenticated');
        window.location.href = '/login.html';
        return;
      }
      if (!AuthService.validateTokenExpiry()) {
        console.warn('Settings access denied: Token expired');
        window.location.href = '/login.html';
        return;
      }
      AuthService.startTokenValidation();
      console.log('Settings authentication check passed');
    })();
  </script>
  <script src="/js/portfolio.js"></script>
  <script src="/js/api.js"></script>
  <script src="/js/main.js"></script>
  <script src="/js/theme-switcher.js"></script>
  <script src="/js/testimonies.js"></script>
  <script src="/js/scrolling-banner.js"></script>
  <script>
    // Logout function
    function logout() {
      AuthService.stopTokenValidation();
      AuthService.logout();
      window.location.href = '/login.html';
    }
  </script>
</body>
</html>
